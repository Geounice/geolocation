<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Géolocalisation et Azimut avec Realtime Database et Turf.js</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        // Assurez-vous que l'URL d'importation de Turf.js est correcte et fonctionnelle dans votre environnement
        import turf from 'https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/dist/turf.min.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAGVZa33uk5y1PY6vkyCj3-QTu-Uw8Nc98",
            authDomain: "geolocalisation-unice.firebaseapp.com",
            projectId: "geolocalisation-unice",
            storageBucket: "geolocalisation-unice.appspot.com",
            messagingSenderId: "256256594187",
            appId: "1:256256594187:web:f931955318ff8a04b5120e",
            databaseURL: "https://geolocalisation-unice-default-rtdb.europe-west1.firebasedatabase.app/"
        };

        // Initialisation de Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let azimuth = 'Non disponible'; // Initialisation de l'azimut à 'Non disponible'

        function handleDeviceOrientation(event) {
            azimuth = event.alpha; // Orientation de l'appareil en degrés autour de l'axe Z
            document.getElementById("azimuth").textContent = "Azimut: " + (azimuth ? azimuth.toFixed(2) + "°" : "Non disponible");
        }

        async function saveLocationAndAzimuth(latitude, longitude, altitude) {
            await set(ref(database, 'locations/lastLocation'), {
                latitude,
                longitude,
                altitude: altitude || "Non disponible",
                azimuth: azimuth || "Non disponible"
            });
            console.log("Localisation et azimut sauvegardés");
        }

        async function retrieveLocationAndAzimuth() {
            const snapshot = await get(ref(database, 'locations/lastLocation'));
            if (snapshot.exists()) {
                const data = snapshot.val();
                document.getElementById("latitude").textContent = "Latitude: " + data.latitude;
                document.getElementById("longitude").textContent = "Longitude: " + data.longitude;
                document.getElementById("altitude").textContent = "Altitude: " + (data.altitude || "Non disponible");
                document.getElementById("azimuth").textContent = "Azimut: " + (data.azimuth || "Non disponible");
            } else {
                console.log("Aucune donnée trouvée");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(permissionState => {
                    if (permissionState === 'granted') {
                        window.addEventListener('deviceorientation', handleDeviceOrientation, true);
                    }
                }).catch(console.error);
            } else {
                window.addEventListener('deviceorientation', handleDeviceOrientation, true);
            }

            retrieveLocationAndAzimuth();
        });

        window.saveCurrentLocationAndAzimuth = async function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const altitude = position.coords.altitude || 'Non disponible';
                    await saveLocationAndAzimuth(latitude, longitude, altitude);
                    retrieveLocationAndAzimuth();
                }, (error) => {
                    console.error('Erreur de géolocalisation : ', error);
                });
            } else {
                alert("La géolocalisation n'est pas supportée par ce navigateur.");
            }
        };
 // Fonction pour gérer les données d'orientation
      function handleOrientation(event) {
          var alpha = event.alpha; // Azimut
          var beta = event.beta;  // Pitch
          var gamma = event.gamma; // Roll
        window.saveCurrentLocationAndAzimuth = async function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const altitude = position.coords.altitude || 'Non disponible';

                    // Exemple de calcul de distance avec Turf.js (en kilomètres)
                    const point1 = turf.point([longitude, latitude]);
                    // Utilisez un point de référence fixe ou une autre localisation dynamique ici
                    const point2 = turf.point([longitude + 0.01, latitude + 0.01]);
                    const options = {units: 'kilometers'};
                    const distance = turf.distance(point1, point2, options);

                    console.log(`Distance: ${distance} kilomètres`);

                    // Convertissez en mètres et continuez avec la sauvegarde
                    const distanceInMeters = distance * 1000;
                    console.log(`Distance: ${distanceInMeters} mètres`);

                    await saveLocationAndAzimuth(latitude, longitude, altitude);
                    retrieveLocationAndAzimuth();
                }, (error) => {
                    console.error('Erreur de géolocalisation : ', error);
                });
            } else {
                alert("La géolocalisation n'est pas supportée par ce navigateur.");
            }
        };

             // Afficher les valeurs sur la page
          document.getElementById('azimuth').textContent = 'Azimut: ' + alpha.toFixed(2) + '°';
          document.getElementById('pitch').textContent = 'Pitch: ' + beta.toFixed(2) + '°';
          document.getElementById('roll').textContent = 'Roll: ' + gamma.toFixed(2) + '°';
      }

      // Fonction pour demander la permission d'accéder aux données d'orientation
      function requestPermission() {
          if (typeof DeviceOrientationEvent.requestPermission === 'function') {
              DeviceOrientationEvent.requestPermission()
                  .then(permissionState => {
                      if (permissionState === 'granted') {
                          window.addEventListener('deviceorientation', handleOrientation, true);
                      } else {
                          alert("Permission refusée");
                      }
                  })
                  .catch(console.error);
          } else {
              // Les permissions ne sont pas nécessaires pour les navigateurs qui ne sont pas iOS 13+
              window.addEventListener('deviceorientation', handleOrientation, true);
          }
      }
    </script>
</head>
<body>
    <h2>Localisation et Azimut</h2>
    <button onclick="requestPermission()">Demander la Permission d'Orientation</button>
    <button onclick="saveCurrentLocationAndAzimuth()">Sauvegarder Localisation et Azimut</button>
    <div>
        <p id="latitude">Latitude: </p>
        <p id="longitude">Longitude: </p>
        <p id="altitude">Altitude: </p>
        <p id="azimuth">Azimut: </p>
	<p id="azimuth">Azimut: En attente...</p>
    	<p id="pitch">Pitch: En attente...</p>
    	<p id="roll">Roll: En attente...</p>
    </div>
</body>
</html>
